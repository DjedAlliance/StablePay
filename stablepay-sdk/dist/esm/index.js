import{getWeb3 as e,getDjedContract as t,getCoinContracts as n,getDecimals as a,getOracleAddress as r,getOracleContract as i,tradeDataPriceBuySc as s,buyScIsisTx as o,buyScTx as l,approveTx as c,checkAllowance as d}from"djed-sdk";import u,{useContext as m,createContext as h,useState as p,useEffect as w,useRef as y,useCallback as k}from"react";import{defineChain as g,createWalletClient as b,custom as C,createPublicClient as f,http as v,parseEther as E,parseUnits as T,encodeFunctionData as _}from"viem";import{sepolia as N}from"viem/chains";const A={sepolia:{uri:"https://ethereum-sepolia.publicnode.com/",chainId:11155111,djedAddress:"0x624FcD0a1F9B5820c950FefD48087531d38387f4",tokens:{stablecoin:{symbol:"SOD",address:"0x6b930182787F346F18666D167e8d32166dC5eFBD",decimals:18,isDirectTransfer:!0},native:{symbol:"ETH",decimals:18,isNative:!0}},feeUI:0},"milkomeda-mainnet":{uri:"https://rpc-mainnet-cardano-evm.c1.milkomeda.com",chainId:2001,djedAddress:"0x67A30B399F5Ed499C1a6Bc0358FA6e42Ea4BCe76",tokens:{stablecoin:{symbol:"MOD",address:"0xcbA90fB1003b9D1bc6a2b66257D2585011b004e9",decimals:18,isDirectTransfer:!0},native:{symbol:"mADA",decimals:18,isNative:!0}},feeUI:0},"ethereum-classic":{uri:"https://etc.rivet.link",chainId:61,djedAddress:"0xCc3664d7021FD36B1Fe2b136e2324710c8442cCf",tokens:{stablecoin:{symbol:"ECSD",address:"0x5A7Ca94F6E969C94bef4CE5e2f90ed9d4891918A",decimals:18,isDirectTransfer:!0},native:{symbol:"ETC",decimals:18,isNative:!0}},feeUI:0}};var S=[{inputs:[{internalType:"string",name:"name",type:"string"},{internalType:"string",name:"symbol",type:"string"}],stateMutability:"nonpayable",type:"constructor"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"owner",type:"address"},{indexed:!0,internalType:"address",name:"spender",type:"address"},{indexed:!1,internalType:"uint256",name:"value",type:"uint256"}],name:"Approval",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"from",type:"address"},{indexed:!0,internalType:"address",name:"to",type:"address"},{indexed:!1,internalType:"uint256",name:"value",type:"uint256"}],name:"Transfer",type:"event"},{inputs:[{internalType:"address",name:"owner",type:"address"},{internalType:"address",name:"spender",type:"address"}],name:"allowance",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"spender",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"}],name:"approve",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"account",type:"address"}],name:"balanceOf",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"spender",type:"address"},{internalType:"uint256",name:"subtractedValue",type:"uint256"}],name:"decreaseAllowance",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"spender",type:"address"},{internalType:"uint256",name:"addedValue",type:"uint256"}],name:"increaseAllowance",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"name",outputs:[{internalType:"string",name:"",type:"string"}],stateMutability:"view",type:"function"},{inputs:[],name:"symbol",outputs:[{internalType:"string",name:"",type:"string"}],stateMutability:"view",type:"function"},{inputs:[],name:"totalSupply",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"to",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"}],name:"transfer",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"from",type:"address"},{internalType:"address",name:"to",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"}],name:"transferFrom",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"decimals",outputs:[{internalType:"uint8",name:"",type:"uint8"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"to",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"}],name:"mint",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"from",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"}],name:"burn",outputs:[],stateMutability:"nonpayable",type:"function"}];class x{constructor(e,t,n=null){this.networkUri=e,this.djedAddress=t,this.baseAssetAddress=n}async init(){if(!this.networkUri||!this.djedAddress)throw new Error("Network URI and DJED address are required");try{this.web3=await e(this.networkUri),this.djedContract=t(this.web3,this.djedAddress),this.baseAssetAddress&&(this.baseAssetContract=new this.web3.eth.Contract(S,this.baseAssetAddress));try{const{stableCoin:e,reserveCoin:t}=await n(this.djedContract,this.web3),{scDecimals:s,rcDecimals:o}=await a(e,t);this.stableCoin=e,this.reserveCoin=t,this.scDecimals=s,this.rcDecimals=o,this.oracleContract=await r(this.djedContract).then((e=>i(this.web3,e,this.djedContract._address))),this.oracleAddress=this.oracleContract._address}catch(e){if(console.error("[Transaction] Error fetching contract details:",e),e.message&&e.message.includes("execution reverted")){const e=e=>e.includes("milkomeda")?{name:"Milkomeda",chainId:"2001"}:e.includes("mordor")?{name:"Mordor Testnet",chainId:"63"}:e.includes("sepolia")?{name:"Sepolia",chainId:"11155111"}:e.includes("etc.rivet.link")?{name:"Ethereum Classic",chainId:"61"}:{name:"the selected network",chainId:"unknown"},{name:t,chainId:n}=e(this.networkUri);throw new Error(`Failed to interact with Djed contract at ${this.djedAddress} on ${t}.\n\nPossible causes:\n- The contract address may be incorrect\n- The contract may not be deployed on ${t}\n- The contract may not be a valid Djed contract\n\nPlease verify the contract address is correct for ${t} (Chain ID: ${n}).`)}throw e}}catch(e){if(console.error("[Transaction] Error initializing transaction:",e),e.message&&(e.message.includes("CONNECTION ERROR")||e.message.includes("ERR_NAME_NOT_RESOLVED"))){const e=(e=>e.includes("milkomeda")?"Milkomeda":e.includes("mordor")?"Mordor":e.includes("sepolia")?"Sepolia":"the selected network")(this.networkUri);throw new Error(`Failed to connect to ${e} RPC endpoint: ${this.networkUri}\n\nPossible causes:\n- The RPC endpoint may be temporarily unavailable\n- DNS resolution issue (check your internet connection)\n- Network firewall blocking the connection\n\nPlease try again in a few moments or check the network status.`)}throw e}}getBlockchainDetails(){return{web3Available:!!this.web3,djedContractAvailable:!!this.djedContract,stableCoinAddress:this.stableCoin?this.stableCoin._address:"N/A",reserveCoinAddress:this.reserveCoin?this.reserveCoin._address:"N/A",stableCoinDecimals:this.scDecimals,reserveCoinDecimals:this.rcDecimals,oracleAddress:this.oracleAddress||"N/A",oracleContractAvailable:!!this.oracleContract}}async handleTradeDataBuySc(e){if(!this.djedContract)throw new Error("DJED contract is not initialized");if("string"!=typeof e)throw new Error("Amount must be a string");try{return(await s(this.djedContract,this.scDecimals,e)).totalBCScaled}catch(e){throw console.error("Error fetching trade data for buying stablecoins: ",e),e}}async buyStablecoins(e,t,n){if(!this.djedContract)throw new Error("DJED contract is not initialized");try{const a="0x0232556C83791b8291E9b23BfEa7d67405Bd9839";if(this.baseAssetAddress){if(!this.baseAssetContract)throw new Error("Base Asset contract not initialized for ERC20 flow");return o(this.djedContract,e,t,n,a,this.djedAddress)}return l(this.djedContract,e,t,n,a,this.djedAddress)}catch(e){throw console.error("Error executing buyStablecoins transaction: ",e),e}}async approveBaseAsset(e,t){if(!this.baseAssetContract)throw new Error("No Base Asset contract to approve");return c(this.baseAssetContract,e,this.djedAddress,t)}async checkBaseAssetAllowance(e){return this.baseAssetContract?d(this.baseAssetContract,e,this.djedAddress):"Inf"}}var D="main_stablePayButton__UA7HC",P="main_logo__ITyEy",M="main_buttonText__N-ewy";const I=({onClick:e,size:t="medium"})=>{const n={small:{width:"200px",height:"50px",fontSize:"14px"},medium:{width:"250px",height:"60px",fontSize:"16px"},large:{width:"300px",height:"70px",fontSize:"18px"}},a={small:{width:"35px",height:"33px"},medium:{width:"40px",height:"38px"},large:{width:"45px",height:"43px"}},r=n[t]||n.medium,i=a[t]||a.medium;return u.createElement("button",{className:D,onClick:e,style:r},u.createElement("div",{className:P,style:i}),u.createElement("span",{className:M},"Pay with StablePay"))};var B={dialogOverlay:"PricingCard_dialogOverlay__0XJrE",pricingCard:"PricingCard_pricingCard__LrWb9",small:"PricingCard_small__J4CHj",medium:"PricingCard_medium__EVmTB",large:"PricingCard_large__A6pnX",dialogClose:"PricingCard_dialogClose__jJ1tM",pricingCardHeader:"PricingCard_pricingCardHeader__wGczA",allianceLogo:"PricingCard_allianceLogo__URa-U",stablepayTitle:"PricingCard_stablepayTitle__4t848",pricingCardBody:"PricingCard_pricingCardBody__0wKQn",selectField:"PricingCard_selectField__LBPoZ",transactionReview:"PricingCard_transactionReview__Ix-eL",transactionInfo:"PricingCard_transactionInfo__Ck-Rc",transactionLabel:"PricingCard_transactionLabel__GDux7",transactionValue:"PricingCard_transactionValue__q-xxp",infoSection:"PricingCard_infoSection__gyjMQ",infoIcon:"PricingCard_infoIcon__rraxD",infoText:"PricingCard_infoText__l4b7A",walletButton:"PricingCard_walletButton__llw4v",loading:"PricingCard_loading__2-tGA",error:"PricingCard_error__m5fK-",networkError:"PricingCard_networkError__zR-36",errorText:"PricingCard_errorText__qZRJt","message-box":"PricingCard_message-box__vkUKy",detailsButton:"PricingCard_detailsButton__jHglL",errorDetails:"PricingCard_errorDetails__CzN-7",loadingContainer:"PricingCard_loadingContainer__6nOVa",spinner:"PricingCard_spinner__9ucQv",spin:"PricingCard_spin__24tni"};const j=({children:e,onClose:t,size:n="medium"})=>u.createElement("div",{className:B.dialogOverlay},u.createElement("div",{className:`${B.pricingCard} ${B[n]}`},u.createElement("button",{className:B.dialogClose,onClick:t},"×"),u.createElement("div",{className:B.pricingCardHeader},u.createElement("div",{className:B.allianceLogo}),u.createElement("h2",{className:B.stablepayTitle},"StablePay")),u.createElement("div",{className:B.pricingCardBody},e)));class ${constructor(e){this.networkSelector=e,this.selectedToken=null}selectToken(e){const t=this.networkSelector.getSelectedNetworkConfig();return!(!t||!t.tokens[e])&&(this.selectedToken={key:e,...t.tokens[e]},!0)}getSelectedToken(){return this.selectedToken}getAvailableTokens(){const e=this.networkSelector.getSelectedNetworkConfig();return e?Object.entries(e.tokens).map((([e,t])=>({key:e,...t}))):[]}resetSelection(){this.selectedToken=null}}const F=h(),U=({children:e,networkSelector:t})=>{const[n]=p((()=>new $(t))),[a,r]=p(null),[i,s]=p(null),[o,l]=p(null),c=()=>{s(null),l(null)};return w((()=>{r(t.selectedNetwork)}),[t.selectedNetwork]),u.createElement(F.Provider,{value:{networkSelector:t,tokenSelector:n,selectedNetwork:a,selectedToken:i,transactionDetails:o,setTransactionDetails:l,selectNetwork:e=>!!t.selectNetwork(e)&&(r(e),c(),!0),selectToken:e=>{if(n.selectToken(e)){const e=n.getSelectedToken();return s(e),!0}return!1},resetSelections:()=>{t.selectNetwork(null),r(null),c()}}},e)},R=()=>{const e=m(F);if(void 0===e)throw new Error("useNetwork must be used within a NetworkProvider");return e},z=()=>{const{networkSelector:e,selectedNetwork:t,selectNetwork:n}=R();return u.createElement("div",{className:B.selectField},u.createElement("label",{htmlFor:"network-select"},"Select Network"),u.createElement("select",{id:"network-select",onChange:e=>{n(e.target.value)},value:t||""},u.createElement("option",{value:"",disabled:!0},"Select a network"),Object.keys(e.availableNetworks).map((e=>u.createElement("option",{key:e,value:e},e)))))},L=()=>{const{networkSelector:e,tokenSelector:t,selectedNetwork:n,selectedToken:a,selectToken:r,setTransactionDetails:i}=R(),[s,o]=p(!1),[l,c]=p(null),d=n?t.getAvailableTokens():[];return u.createElement("div",{className:B.selectField},u.createElement("label",{htmlFor:"token-select"},"Select Token"),u.createElement("select",{id:"token-select",onChange:async a=>{const s=a.target.value;c(null),o(!0);try{if(r(s)){const a=e.getSelectedNetworkConfig(),r=new x(a.uri,a.djedAddress);await r.init();const o=e.getTokenAmount(s),l=r.getBlockchainDetails();let c=null;"native"===s&&(c=await r.handleTradeDataBuySc(String(o))),i({network:n,token:s,tokenSymbol:t.getSelectedToken().symbol,amount:o,receivingAddress:e.getReceivingAddress(),djedContractAddress:a.djedAddress,isDirectTransfer:t.getSelectedToken().isDirectTransfer||!1,isNativeToken:t.getSelectedToken().isNative||!1,tradeAmount:c?c.amount:null,...l})}}catch(e){console.error("Error fetching transaction details:",e),c("Failed to fetch transaction details. Please try again.")}finally{o(!1)}},value:a?a.key:"",disabled:!n||s},u.createElement("option",{value:"",disabled:!0},n?s?"Loading...":"Select a token":"Please select a network first"),d.map((e=>u.createElement("option",{key:e.key,value:e.key},e.symbol," (",e.isDirectTransfer?"Direct Transfer":"Native",")")))),l&&u.createElement("div",{className:B.error},l))};g({id:63,name:"Mordor Testnet",network:"mordor",nativeCurrency:{decimals:18,name:"Mordor Ether",symbol:"METC"},rpcUrls:{default:{http:["https://rpc.mordor.etccooperative.org"],webSocket:["wss://rpc.mordor.etccooperative.org/ws"]}},blockExplorers:{default:{name:"BlockScout",url:"https://blockscout.com/etc/mordor"}},testnet:!0});const O=g({id:2001,name:"Milkomeda C1 Mainnet",network:"milkomeda",nativeCurrency:{decimals:18,name:"Milkomeda ADA",symbol:"mADA"},rpcUrls:{default:{http:["https://rpc-mainnet-cardano-evm.c1.milkomeda.com"]}},blockExplorers:{default:{name:"Milkomeda Explorer",url:"https://explorer-mainnet-cardano-evm.c1.milkomeda.com"}},testnet:!1}),W=g({id:61,name:"Ethereum Classic",network:"etc",nativeCurrency:{decimals:18,name:"Ethereum Classic",symbol:"ETC"},rpcUrls:{default:{http:["https://etc.rivet.link"]}},blockExplorers:{default:{name:"Blockscout",url:"https://blockscout.com/etc/mainnet"}},testnet:!1}),q=h(null),H=async e=>{if(!window.ethereum)throw new Error("MetaMask not installed");const t=(e=>{switch(e){case"sepolia":return{chainId:`0x${N.id.toString(16)}`,chainName:"Sepolia",nativeCurrency:{name:"Ether",symbol:"ETH",decimals:18},rpcUrls:N.rpcUrls.default.http,blockExplorerUrls:N.blockExplorers?.default?.url?[N.blockExplorers.default.url]:[]};case"ethereum-classic":return{chainId:`0x${W.id.toString(16)}`,chainName:"Ethereum Classic",nativeCurrency:{name:"Ethereum Classic",symbol:"ETC",decimals:18},rpcUrls:["https://etc.rivet.link"],blockExplorerUrls:["https://blockscout.com/etc/mainnet"]};case"milkomeda-mainnet":return{chainId:`0x${O.id.toString(16)}`,chainName:"Milkomeda C1 Mainnet",nativeCurrency:{name:"Milkomeda ADA",symbol:"mADA",decimals:18},rpcUrls:["https://rpc-mainnet-cardano-evm.c1.milkomeda.com"],blockExplorerUrls:["https://explorer-mainnet-cardano-evm.c1.milkomeda.com"]};default:return null}})(e);if(!t)throw new Error(`Unsupported network: ${e}`);try{await window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:t.chainId}]})}catch(e){if(4902!==e.code)throw 4001===e.code?new Error(`User rejected switching to ${t.chainName}. Please switch manually in MetaMask.`):new Error(`Failed to switch to ${t.chainName}: ${e.message}`);try{await window.ethereum.request({method:"wallet_addEthereumChain",params:[t]})}catch(e){if(4001===e.code)throw new Error(`User rejected adding ${t.chainName} to MetaMask. Please add it manually.`);throw new Error(`Failed to add ${t.chainName} to MetaMask: ${e.message}`)}}},V=({children:e})=>{const{selectedNetwork:t}=R(),[n,a]=p(null),[r,i]=p(null),[s,o]=p(null),[l,c]=p(null),[d,m]=p(null),[h,g]=p(null),[E,T]=p(!1),_=t?(e=>{switch(e){case"sepolia":return N;case"ethereum-classic":return W;case"milkomeda-mainnet":return O;default:return null}})(t):null,A=_?_.id:null,S=y(null),x=y(null),D=k((()=>{a(null),i(null),o(null),c(null),m(null),g(null)}),[]),P=k((async e=>{const n=parseInt(e,16);if(c(n),_&&n===A){if(g(null),window.ethereum&&_){const e=b({chain:_,transport:C(window.ethereum)});a(e)}}else if(_&&n!==A){g(`Wrong network detected. Please switch to ${_?.name||t||"selected network"}`)}}),[_,A,t]);x.current=P;const M=k((async e=>{if(0===e.length){if(D(),window.ethereum){const e=S.current,t=x.current;e&&window.ethereum.removeListener("accountsChanged",e),t&&window.ethereum.removeListener("chainChanged",t)}}else if(o(e[0]),_)try{const t=f({chain:_,transport:v()});i(t);const n=await t.getBalance({address:e[0]});m(parseFloat(n)/Math.pow(10,18))}catch(e){console.error("Error fetching balance:",e),m(null)}}),[_,D]);S.current=M;const I=k((()=>{if(D(),window.ethereum){const e=S.current,t=x.current;e&&window.ethereum.removeListener("accountsChanged",e),t&&window.ethereum.removeListener("chainChanged",t)}}),[D]),B=k((()=>{_&&i(f({chain:_,transport:v()}))}),[_]),j=k((async()=>{if(!window.ethereum)return g("Please install MetaMask or another Web3 wallet"),!1;if(!t||!_)return g("Please select a network first"),!1;T(!0),g(null);try{const e=await window.ethereum.request({method:"eth_requestAccounts"});if(0===e.length)throw new Error("No wallet address found. Please unlock your wallet.");const n=await window.ethereum.request({method:"eth_chainId"});parseInt(n,16)!==A&&await H(t);const r=b({chain:_,transport:C(window.ethereum)});a(r),o(e[0]),c(A);const s=f({chain:_,transport:v()});i(s);try{const t=await s.getBalance({address:e[0]});m(parseFloat(t)/Math.pow(10,18))}catch(e){console.error("Error fetching balance:",e),m(null)}return S.current=M,x.current=P,window.ethereum.on("accountsChanged",M),window.ethereum.on("chainChanged",P),!0}catch(e){return console.error("Error connecting wallet:",e),g(e.message),!1}finally{T(!1)}}),[t,_,A,M,P]),$=k((async()=>{if(!(window.ethereum&&t&&_&&s)){return g("Wallet not connected or network not selected"),null}try{const e=await window.ethereum.request({method:"eth_chainId"});if(parseInt(e,16)!==A){g(null),await H(t);const e=500;await new Promise((t=>setTimeout(t,e)));const n=await window.ethereum.request({method:"eth_chainId"}),a=parseInt(n,16);if(a!==A)throw new Error(`Failed to switch network. MetaMask is still on chain ${a}, expected ${A}`)}const n=b({chain:_,transport:C(window.ethereum)});return a(n),c(A),g(null),n}catch(e){return g(e.message),null}}),[t,_,A,s]),F=y(t);return w((()=>{if(null!==F.current&&F.current!==t&&s&&(D(),window.ethereum)){const e=S.current,t=x.current;e&&window.ethereum.removeListener("accountsChanged",e),t&&window.ethereum.removeListener("chainChanged",t)}F.current=t}),[t,s,D]),w((()=>{B()}),[B]),u.createElement(q.Provider,{value:{walletClient:n,publicClient:r,account:s,chainId:l,balance:d,error:h,isConnecting:E,connectWallet:j,disconnectWallet:I,ensureCorrectNetwork:$,expectedChainId:A}},e)},J=({onTransactionComplete:e})=>{const{networkSelector:t,selectedNetwork:n,selectedToken:a,transactionDetails:r,setTransactionDetails:i}=R(),{connectWallet:s,account:o,walletClient:l,publicClient:c,isConnecting:d,ensureCorrectNetwork:h,expectedChainId:y}=(()=>{const e=m(q);if(!e)throw new Error("useWallet must be used within a WalletProvider");return e})(),[k,g]=p(null),[b,C]=p(null),[f,v]=p(null),[N,A]=p(""),[S,D]=p(null),[P,M]=p(null),[I,j]=p(!1);if(w((()=>{v(null),C(null),A(""),M(null),D(null)}),[n,a]),w((()=>{(async()=>{if(n&&a)try{const e=t.getSelectedNetworkConfig(),r=t.getReceivingAddress(),s=t.getTokenAmount(a.key),o=new x(e.uri,e.djedAddress);await o.init(),g(o);let l=null;if("native"===a.key)try{l=await o.handleTradeDataBuySc(String(s)),C(l)}catch(e){console.error("Error fetching trade data:",e)}i({network:n,token:a.key,tokenSymbol:a.symbol,amount:s||"0",receivingAddress:r,djedContractAddress:e.djedAddress,isDirectTransfer:a.isDirectTransfer||!1,isNativeToken:a.isNative||!1,tradeAmount:l?l.amount:null,...o.getBlockchainDetails()})}catch(e){console.error("Error initializing transaction:",e)}})()}),[n,a,t,i]),!r)return u.createElement("div",{className:B.loading},"Initializing transaction...");const $=()=>{if(!S||!n)return null;const e={"ethereum-classic":"https://blockscout.com/etc/mainnet/tx/",sepolia:"https://sepolia.etherscan.io/tx/","milkomeda-mainnet":"https://explorer-mainnet-cardano-evm.c1.milkomeda.com/tx/"};return e[n]?`${e[n]}${S}`:null};return u.createElement("div",{className:B.transactionReview},u.createElement("div",{className:B.transactionInfo},u.createElement("span",{className:B.transactionLabel},"Network:"),u.createElement("span",{className:B.transactionValue},r.network)),u.createElement("div",{className:B.transactionInfo},u.createElement("span",{className:B.transactionLabel},"You Pay:"),u.createElement("span",{className:B.transactionValue},"stablecoin"===a.key?`${r.amount} ${r.tokenSymbol}`:`${b||"Calculating..."} ${r.tokenSymbol}`)),u.createElement("button",{className:B.walletButton,onClick:async()=>{await s()},disabled:d},d?"Connecting...":"Connect Wallet"),o&&!f&&u.createElement("button",{className:B.walletButton,onClick:async()=>{if(o&&r&&k)try{v(null),M(null),A("⏳ Preparing transaction...");const e=r.receivingAddress;let n;if("native"===a.key){const t="0x0232556C83791b8291E9b23BfEa7d67405Bd9839",a=E(String(b||"0"));n=await k.buyStablecoins(o,e,a,t),n={...n,value:a,account:o}}else{const a=t.getSelectedNetworkConfig(),i=a?.tokens?.stablecoin?.address;if(!i)throw new Error("Stablecoin address not found in network configuration");const s=r.amount?T(String(r.amount),r.stableCoinDecimals):"0";n={to:i,value:0n,data:_({abi:[{inputs:[{internalType:"address",name:"to",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"}],name:"transfer",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"}],functionName:"transfer",args:[e,s]}),account:o}}v(n),A("✅ Transaction ready! Click 'Send Transaction' to proceed.")}catch(e){M(e),A("❌ Transaction preparation failed.")}else A("❌ Wallet not connected or transaction details missing")}},"Prepare Transaction"),o&&f&&u.createElement("button",{className:B.walletButton,onClick:async()=>{M(null);try{if(!o||!f)return void A("❌ Wallet account or transaction data is missing");if(!n)return void A("❌ Network not selected");const i=t.getSelectedNetworkConfig();if(!i)return void A("❌ Network configuration not found");A("⏳ Verifying network...");const s=await h();if(!s)return void A("❌ Failed to switch to correct network. Please approve the network switch in MetaMask and try again.");if(!window.ethereum)return void A("❌ MetaMask not available");const l=await window.ethereum.request({method:"eth_chainId"}),c=parseInt(l,16);if(c!==i.chainId){const e=`Network mismatch. MetaMask is on chain ${c}, but ${n} requires chain ${i.chainId}. Please switch networks in MetaMask.`;return A(`❌ ${e}`),void M(new Error(e))}if(s.chain.id!==i.chainId){const e=`Wallet client chain mismatch. Wallet client is on chain ${s.chain.id}, but expected ${i.chainId}.`;return A(`❌ ${e}`),void M(new Error(e))}A("⏳ Sending transaction...");const d=await s.sendTransaction({...f,account:o});D(d),A("✅ Transaction sent!"),e&&e({txHash:d,network:n,token:a?.key,tokenSymbol:a?.symbol,amount:r?.amount,receivingAddress:r?.receivingAddress})}catch(e){M(e),A("❌ Transaction failed."),console.error("Transaction error:",e)}},disabled:null!==S},"Send Transaction"),N&&u.createElement("div",{className:"message-box"},N,P&&u.createElement("button",{onClick:()=>j(!I),className:B.detailsButton},I?"Hide Details":"Show Details")),I&&P&&u.createElement("div",{className:B.errorDetails},u.createElement("pre",null,P.message)),S&&u.createElement("div",{className:B.transactionLink},"✅ Transaction Hash:"," ",$()?u.createElement("a",{href:$(),target:"_blank",rel:"noopener noreferrer",className:B.explorerLink,style:{color:"#007bff",textDecoration:"underline",fontWeight:"bold",cursor:"pointer",wordBreak:"break-word"}},S.slice(0,6),"...",S.slice(-6)):u.createElement("span",{style:{wordBreak:"break-word"}},S)))},G=({onClose:e,buttonSize:t,onTransactionComplete:n})=>{const{resetSelections:a}=R();return u.createElement(j,{onClose:()=>{a(),e()},size:t},u.createElement(z,null),u.createElement(L,null),u.createElement(J,{onTransactionComplete:n}))},K=({onClose:e,buttonSize:t,networkSelector:n,onTransactionComplete:a})=>u.createElement(U,{networkSelector:n},u.createElement(V,null,u.createElement(G,{onClose:e,buttonSize:t,onTransactionComplete:a}))),Q={NetworkSelector:class{constructor(e){this.merchantConfig=e,this.blacklist=e.getBlacklist(),this.availableNetworks=this.getAvailableNetworks(),this.selectedNetwork=null}getAvailableNetworks(){return Object.entries(A).reduce(((e,[t,n])=>(this.blacklist.includes(n.chainId)||(e[t]=n),e)),{})}selectNetwork(e){return null===e?(this.selectedNetwork=null,console.log("Network selection reset"),!0):this.availableNetworks[e]?(this.selectedNetwork=e,console.log(`Network selected: ${e}`),!0):(console.error(`Invalid network: ${e}`),!1)}getSelectedNetworkConfig(){return this.selectedNetwork?this.availableNetworks[this.selectedNetwork]:null}getReceivingAddress(){return this.merchantConfig.getReceivingAddress()}getTokenAmount(e){return this.merchantConfig.getTokenAmount(this.selectedNetwork,e)}},Transaction:x,Config:class{constructor(e={}){this.receivingAddress=e.receivingAddress||"",this.blacklist=e.blacklist||[],this.amounts=e.Amounts||{},this.validateConfig()}validateConfig(){if(!this.receivingAddress)throw new Error("Receiving address is required");for(const[e,t]of Object.entries(this.amounts)){if(!A[e])throw new Error(`Invalid network: ${e}`);if(!t.stablecoin||"number"!=typeof t.stablecoin||t.stablecoin<=0)throw new Error(`Invalid stablecoin amount for network ${e}`)}}getBlacklist(){return this.blacklist}getReceivingAddress(){return this.receivingAddress}getTokenAmount(e){console.log("Getting amount for network:",e),console.log("Amounts object:",this.amounts);const t=this.amounts[e]?.stablecoin;return console.log("Returning amount:",t),t||0}},Widget:({networkSelector:e,buttonSize:t="medium",onTransactionComplete:n,onSuccess:a})=>{const[r,i]=p(!1),s=n||a;return u.createElement("div",{className:B.widgetContainer},!r&&u.createElement(I,{onClick:()=>{i(!0)},size:t}),r&&u.createElement(K,{onClose:()=>{i(!1)},buttonSize:t,networkSelector:e,onTransactionComplete:s}))},PayButton:I,Dialog:j,NetworkDropdown:z};export{Q as default};
