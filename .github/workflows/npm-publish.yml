name: NPM Publish

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'djed-sdk/package.json'
      - 'stablepay-sdk/package.json'

jobs:
  publish-djed-sdk:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: ./djed-sdk
    permissions:
      contents: read
      id-token: write 
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: Check version change
        id: check
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          LOCAL_VERSION=$(node -p "require('./package.json').version")
          
          echo "Checking registry for $PACKAGE_NAME..."
          
          # Retry loop for npm view to handle network flakes
          PUBLISHED_VERSION=""
          for i in {1..3}; do
            if OUTPUT=$(npm view "$PACKAGE_NAME" version 2>/dev/null); then
              PUBLISHED_VERSION=$OUTPUT
              break
            else
              # Check if it's a 404 (package doesn't exist)
              if npm view "$PACKAGE_NAME" version 2>&1 | grep -q "E404"; then
                echo "Package not found on registry. Assuming new package."
                PUBLISHED_VERSION="0.0.0"
                break
              fi
              
              if [ $i -lt 3 ]; then
                echo "Attempt $i failed. Retrying in 5 seconds..."
                sleep 5
              fi
            fi
          done

          if [ -z "$PUBLISHED_VERSION" ]; then
             echo "Failed to retrieve published version after 3 attempts. Assuming 0.0.0 to err on side of attempting publish."
             PUBLISHED_VERSION="0.0.0"
          fi
          
          echo "Local version: $LOCAL_VERSION"
          echo "Published version: $PUBLISHED_VERSION"
          
          if [ "$LOCAL_VERSION" != "$PUBLISHED_VERSION" ]; then
            echo "Version changed."
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "Version unchanged."
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install dependencies
        if: steps.check.outputs.changed == 'true'
        run: |
          for i in {1..3}; do
            npm ci && break || {
              echo "Install failed, retrying in 10 seconds..."
              sleep 10
            }
          done

      - name: Build
        if: steps.check.outputs.changed == 'true'
        run: npm run build

      - name: Publish to NPM
        if: steps.check.outputs.changed == 'true'
        run: |
          for i in {1..3}; do
            npm publish && break || {
              echo "Publish failed, retrying in 10 seconds..."
              sleep 10
            }
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-stablepay-sdk:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: ./stablepay-sdk
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: Check version change
        id: check
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          LOCAL_VERSION=$(node -p "require('./package.json').version")
          
          echo "Checking registry for $PACKAGE_NAME..."

          PUBLISHED_VERSION=""
          for i in {1..3}; do
            if OUTPUT=$(npm view "$PACKAGE_NAME" version 2>/dev/null); then
              PUBLISHED_VERSION=$OUTPUT
              break
            else
              if npm view "$PACKAGE_NAME" version 2>&1 | grep -q "E404"; then
                echo "Package not found on registry. Assuming new package."
                PUBLISHED_VERSION="0.0.0"
                break
              fi
              
              if [ $i -lt 3 ]; then
                echo "Attempt $i failed. Retrying in 5 seconds..."
                sleep 5
              fi
            fi
          done

          if [ -z "$PUBLISHED_VERSION" ]; then
             echo "Failed to retrieve published version after 3 attempts. Assuming 0.0.0 to err on side of attempting publish."
             PUBLISHED_VERSION="0.0.0"
          fi
          
          echo "Local version: $LOCAL_VERSION"
          echo "Published version: $PUBLISHED_VERSION"
          
          if [ "$LOCAL_VERSION" != "$PUBLISHED_VERSION" ]; then
            echo "Version changed."
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "Version unchanged."
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install dependencies
        if: steps.check.outputs.changed == 'true'
        run: |
          for i in {1..3}; do
            npm ci && break || {
              echo "Install failed, retrying in 10 seconds..."
              sleep 10
            }
          done

      - name: Build
        if: steps.check.outputs.changed == 'true'
        run: npm run build

      - name: Publish to NPM
        if: steps.check.outputs.changed == 'true'
        run: |
          for i in {1..3}; do
            npm publish && break || {
              echo "Publish failed, retrying in 10 seconds..."
              sleep 10
            }
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
